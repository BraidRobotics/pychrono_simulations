# Stage 1: Build Chrono with Irrlicht and Python bindings
FROM ubuntu:22.04 AS chrono-builder

RUN apt-get update && apt-get install -y \
  libirrlicht-dev libeigen3-dev cmake build-essential ninja-build \
  swig libxxf86vm-dev freeglut3-dev python3 python3-pip python3-numpy \
  python3-venv python3-dev libglu1-mesa-dev libglew-dev libglfw3-dev \
  libblas-dev liblapack-dev git xorg-dev

RUN git clone --recursive -b 7.0.3 https://github.com/projectchrono/chrono.git /chrono
RUN cd /chrono && git submodule update --init --recursive

RUN mkdir -p /chrono/build && cd /chrono/build && \
  cmake .. -G Ninja \
    -DCMAKE_BUILD_TYPE=Release \
    -DENABLE_MODULE_PYTHON=ON \
    -DENABLE_MODULE_IRRLICHT=ON \
    -DPYTHON_EXECUTABLE=$(which python3) \
    -DPYTHON_VERSION=$(python3 -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')") \
    -DCMAKE_INSTALL_PREFIX=/chrono/install \
    -DBUILD_DEMOS=OFF \
  && ninja && ninja install \
  && PY_SITE=$(python3 -c "import site; print(site.getsitepackages()[0])") \
  && mkdir -p $PY_SITE \
  && cp -r /chrono/install/share/chrono/python/pychrono $PY_SITE/
  
ENV PYTHONPATH="/chrono/install/share/chrono/python:${PYTHONPATH:-}"


# Stage 2: Runtime environment
FROM ubuntu:22.04

RUN apt-get update && apt-get install -y \
  libirrlicht-dev freeglut3-dev python3 python3-pip python3-numpy \
  libglu1-mesa-dev libglew-dev libglfw3-dev xorg-dev

COPY --from=chrono-builder /chrono/install/share/chrono/python/pychrono \
     /usr/local/lib/python3.10/dist-packages/pychrono

ENV PYTHONPATH="/usr/local/lib/python3.10/dist-packages:$PYTHONPATH"

COPY helloworld.py /home/chrono/helloworld.py

CMD ["bash"]