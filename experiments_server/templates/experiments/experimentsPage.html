{% extends "layout.html" %}
{% block title %}
{% endblock %}
{% block body %}


<h1 style="color: green">Experiment: {{experiment_series.experiment_series_name}}</h1>

<table border="1" cellpadding="5" cellspacing="0">
    <thead>
        <tr>
            <th>Name</th>
            <th>Group Name</th>
            <th style="width: 170px;">Description</th>
            <th># Experiments</th>
            <th>Max Time</th>
            <th title="A negative value means downward force.">Initial Force Y</th>
            <th title="A negative value means downward force.">Final Force Y</th>
            <th title="A negative value means downward force.">Top Nodes Initial Y</th>
            <th title="A negative value means downward force.">Top Nodes Final Y</th>
            <th>Initial Force X</th>
            <th>Final Force X</th>
            <th>Initial Force Z</th>
            <th>Final Force Z</th>
            <th>Torsional Force</th>
            <th>Reset Force After (s)</th>
            <th>Strands</th>
            <th title="Zeroeth Layer counts as 1 layer"># Layers</th>
            <th>Radius</th>
            <th>Radius Taper</th>
            <th title="Smaller pitch ‚Üí tighter twist; larger pitch ‚Üí looser, more vertical strands">Pitch</th>
            <th>Material Thickness</th>
            <th>Weight (kg)</th>
            <th>Height (m)</th>
            <th>Delete Entire Series</th>
        </tr>
    </thead>
    <tbody>
        <tr class="{% if experiment_series.is_experiments_outdated %}outdated{% endif %}">
            <td><a href="/experiments/{{ experiment_series.experiment_series_name }}">{{ experiment_series.experiment_series_name }}</a></td>
            <td>
                <input type="text"
                       value="{{ experiment_series.group_name }}"
                       data-field="group_name"
                       onblur="submitEdit(this)"
                       onkeydown="handleKey(event, this)">
            </td>
            <td>
                <textarea
                    id="description-textarea"
                    data-field="description"
                    onblur="submitEdit(this)"
                    onkeydown="handleKey(event, this)">{{ experiment_series.description }}</textarea>
            </td>
            <td>
                <input type="number"
                       min="1"
                       value="{{ experiment_series.num_experiments }}"
                       data-field="num_experiments"
                       onblur="submitEdit(this)"
                       onkeydown="handleKey(event, this)">
            </td>
            <td>
                <input type="number"
                       min="0"
                       value="{{ experiment_series.max_simulation_time }}"
                       data-field="max_simulation_time"
                       onblur="submitEdit(this)"
                       onkeydown="handleKey(event, this)">
            </td>
            </td>
            <td>
                <input type="number"
                       value="{{ experiment_series.initial_force_applied_in_y_direction }}"
                       data-field="initial_force_applied_in_y_direction"
                       onblur="submitEdit(this)"
                       onkeydown="handleKey(event, this)">
            </td>
            <td>
                <input type="number"
                       value="{{ experiment_series.final_force_in_y_direction }}"
                       data-field="final_force_in_y_direction"
                       onblur="submitEdit(this)"
                       onkeydown="handleKey(event, this)">
            </td>
            <td>
                <input type="number"
                       value="{{ experiment_series.initial_top_nodes_force_in_y_direction }}"
                       data-field="initial_top_nodes_force_in_y_direction"
                       onblur="submitEdit(this)"
                       onkeydown="handleKey(event, this)">
            </td>
            <td>
                <input type="number"
                       value="{{ experiment_series.final_top_nodes_force_in_y_direction }}"
                       data-field="final_top_nodes_force_in_y_direction"
                       onblur="submitEdit(this)"
                       onkeydown="handleKey(event, this)">
            </td>
            <td>
                <input type="number"
                       value="{{ experiment_series.initial_force_applied_in_x_direction }}"
                       data-field="initial_force_applied_in_x_direction"
                       onblur="submitEdit(this)"
                       onkeydown="handleKey(event, this)">
            </td>
            <td>
                <input type="number"
                       value="{{ experiment_series.final_force_in_x_direction }}"
                       data-field="final_force_in_x_direction"
                       onblur="submitEdit(this)"
                       onkeydown="handleKey(event, this)">
            </td>
            <td>
                <input type="number"
                       value="{{ experiment_series.initial_force_applied_in_z_direction }}"
                       data-field="initial_force_applied_in_z_direction"
                       onblur="submitEdit(this)"
                       onkeydown="handleKey(event, this)">
            </td>
            <td>
                <input type="number"
                       value="{{ experiment_series.final_force_in_z_direction }}"
                       data-field="final_force_in_z_direction"
                       onblur="submitEdit(this)"
                       onkeydown="handleKey(event, this)">
            </td>
            <td>
                <input type="number"
                       value="{{ experiment_series.torsional_force }}"
                       data-field="torsional_force"
                       onblur="submitEdit(this)"
                       onkeydown="handleKey(event, this)">
            </td>
            <td>
                <input type="number"
                       value="{{ experiment_series.reset_force_after_seconds }}"
                       data-field="reset_force_after_seconds"
                       onblur="submitEdit(this)"
                       onkeydown="handleKey(event, this)">
            </td>
            <td>
                <input type="number"
                       min="1"
                       value="{{ experiment_series.num_strands }}"
                       data-field="num_strands"
                       onblur="submitEdit(this)"
                       onkeydown="handleKey(event, this)">
            </td>
            <td>
                <input type="number"
                       min="1"
                       value="{{ experiment_series.num_layers }}"
                       data-field="num_layers"
                       onblur="submitEdit(this)"
                       onkeydown="handleKey(event, this)">
            </td>
            <td>
                <input  type="number"
                        min="0.01"
                        step="0.01"
                        value="{{ experiment_series.radius }}"
                        data-field="radius"
                        onblur="submitEdit(this)"
                        onkeydown="handleKey(event, this)">
            </td>
            <td>
                <input  type="number"
                        step="0.01"
                        value="{{ experiment_series.radius_taper }}"
                        data-field="radius_taper"
                        onblur="submitEdit(this)"
                        onkeydown="handleKey(event, this)">
            </td>
            <td>
                <input  type="number"
                        min="0.1"
                        step="0.1"
                        value="{{ experiment_series.pitch }}"
                        data-field="pitch"
                        onblur="submitEdit(this)"
                        onkeydown="handleKey(event, this)">
            </td>
            <td>
                <input type="number"
                       value="{{ experiment_series.material_thickness }}"
                       data-field="material_thickness"
                       onblur="submitEdit(this)"
                       onkeydown="handleKey(event, this)">
            </td>
            <td>{{ "%.2f"|format(experiment_series.weight_kg) if experiment_series.weight_kg is not none else "" }}</td>
            <td>{{ "%.2f"|format(experiment_series.height_m) if experiment_series.height_m is not none else "" }}</td>
            <td>
                <div class="delete-button-wrapper">
                    <form action="/api/experiment_series/delete/{{ experiment_series.experiment_series_name }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this experiment series?');">
                        <button class="delete-button" type="submit">üö´</button>
                    </form>
                </div>
            </td>
        </tr>
    </tbody>
</table>

<form action="/api/experiments/all/{{ experiment_series.experiment_series_name }}" method="POST">
	<button id="run-experiments-button" type="submit">
		{% if experiments %}
			Rerun Experiments (delete old run) ‚ñ∂Ô∏è
		{% else %}
			Run Experiments Series ‚ñ∂Ô∏è
		{% endif %}
	</button>
</form>

<img src="/assets/{{ experiment_series.experiment_series_name }}/model.jpg" alt="Experiment Series Image Not Found Error" style="max-width: 100%; height: auto;">


{% include "experiments/charts.html" %}
{% include "experiments/experimentsTable.html" %}


<script>
    function submitEdit(cell) {
        const field = cell.getAttribute('data-field');
        let value;

        if (cell.tagName === 'INPUT' || cell.tagName === 'SELECT' || cell.tagName === 'TEXTAREA') {
            value = cell.value.trim();
        } else {
            value = cell.innerText.trim();
        }

        const payload = { [field]: value };
        const experimentSeriesName = "{{ experiment_series.experiment_series_name }}";

        fetch(`/api/experiment_series/${experimentSeriesName}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        }).then(async response => {
            if (!response.ok) {
                const errorMessage = await response.json().then(
                    data => `Failed to update: ${data.message || 'Unknown error.'}`,
                    () => 'Failed to update.'
                );
                alert(errorMessage);
            } else {
                window.location.reload();
            }
        }).catch((error) => {
            console.error('There was a problem with the fetch operation:', error);
            alert('Failed to update. Please try again.');
        });
    }

    function handleKey(event, cell) {
        if (event.key === 'Enter') {
            event.preventDefault();
            cell.blur();
        }
    }
</script>

{% endblock %}
